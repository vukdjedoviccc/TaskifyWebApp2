// ============================================================================
// TASKIFY - Prisma Schema (Minimalna verzija)
// 7 modela: User, Project, Board, Column, Task, Label, Notification
// ============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER - Korisnici sistema
// Role: ADMIN, MODERATOR, USER
// ============================================================================
model User {
  id        Int      @id @default(autoincrement())
  name      String   @db.NVarChar(191)
  email     String   @unique @db.NVarChar(191)
  password  String   @db.NVarChar(255)
  // Sistemska rola: ADMIN (pun pristup), MODERATOR (edituje tudje), USER (samo svoje)
  role      String   @default("USER") @db.NVarChar(16)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacije
  ownedProjects Project[]
  createdTasks  Task[]         @relation("TaskCreator")
  assignedTasks Task[]         @relation("TaskAssignee")
  notifications Notification[]
}

// ============================================================================
// PROJECT - Projekti (kontejner za board-ove)
// ============================================================================
model Project {
  id          Int      @id @default(autoincrement())
  name        String   @db.NVarChar(191)
  description String?  @db.NVarChar(Max)
  color       String   @default("#6366f1") @db.NVarChar(7)

  // Vlasnik projekta
  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacije
  boards Board[]
  labels Label[]

  @@index([ownerId])
}

// ============================================================================
// BOARD - Kanban tabla
// ============================================================================
model Board {
  id        Int     @id @default(autoincrement())
  name      String  @db.NVarChar(191)
  projectId Int

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacije
  columns Column[]

  @@index([projectId])
}

// ============================================================================
// COLUMN - Kolone na Kanban tabli (To Do, In Progress, Done)
// ============================================================================
model Column {
  id       Int     @id @default(autoincrement())
  name     String  @db.NVarChar(64)
  boardId  Int
  position Int     @default(0)
  color    String  @default("#6b7280") @db.NVarChar(7)

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacije
  tasks Task[]

  @@index([boardId])
  @@index([boardId, position])
}

// ============================================================================
// TASK - Zadaci/kartice na Kanban tabli
// ============================================================================
model Task {
  id          Int       @id @default(autoincrement())
  title       String    @db.NVarChar(1024)
  description String?   @db.NVarChar(Max)
  columnId    Int
  position    Int       @default(0)
  priority    String    @default("MEDIUM") @db.NVarChar(16)
  dueDate     DateTime?

  // Ko je kreirao task
  createdById Int
  createdBy   User @relation("TaskCreator", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Kome je task dodeljen
  assigneeId Int?
  assignee   User? @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Kolona u kojoj se task nalazi
  column Column @relation(fields: [columnId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Kategorija - 1 label po tasku (pojednostavljeno)
  labelId Int?
  label   Label? @relation(fields: [labelId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([columnId])
  @@index([columnId, position])
  @@index([createdById])
  @@index([assigneeId])
  @@index([labelId])
}

// ============================================================================
// LABEL - Kategorije/labele za taskove
// ============================================================================
model Label {
  id        Int     @id @default(autoincrement())
  name      String  @db.NVarChar(64)
  color     String  @default("#6b7280") @db.NVarChar(7)
  projectId Int

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())

  // Relacije
  tasks Task[]

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================================================
// NOTIFICATION - Obave≈°tenja za korisnike
// ============================================================================
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String   @db.NVarChar(32)
  title     String   @db.NVarChar(255)
  message   String   @db.NVarChar(1000)
  isRead    Boolean  @default(false)
  link      String?  @db.NVarChar(255)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, isRead])
}
